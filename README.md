# bkupman

## バックアップサーバ側

[Design Note](design.md)

## クライアント側 - Windows

Windows の NTFS にもシンボリックリンクとかジャンクションとか ACL (セキュリティ情報)
とか Alternate Data Stream とか怪しいものが多いので、
コピーと圧縮は WSL ではなく Windows 用のツールを使った方が無難に感じる。
VM 跨ぐとファイルシステムが遅いし。。

### ファイルツリー同期

#### Robocopy

Vista あたりから Windows に最初から入っているらしい。
元々 Microsoft 内で海を越えて大量のデータを同期するために開発されたツールらしい。
適当に使うとアクセス制限に引っかかったときに無限リトライしたりする。
頑張って試行錯誤してよさげなコマンドラインを見つける必要がある。

#### SyncToy

Microsoft 公式が出していたよさげなディレクトリ同期ツールだが、
2021 年頃に消えてしまっている。
その辺に落ちていそうだが、危険な偽物を掴まないよう注意。

#### FastCopy

2024年5月でも積極的に更新が行われている。
シェアウェアで職場環境ではライセンスが必要なので注意。
winget でインストール可能。
コマンドライン版も入る。

### 圧縮

zip は ZIP64 (>2GB) 対応と UTF-8 対応が怪しいレガシーシステムが
蔓延しているようなので回避すること。

#### 右クリックのコンテキストメニューから

最近は 2GB 問題もクリアして大丈夫そうに見えるが、コマンドラインからの呼び出し方が
分からない部分がアウト。

#### Powershell (非推奨)

Compress-Archive コマンドで圧縮できると見せかけて、
2GB までしか圧縮できないので使い物にならん模様。

#### Lhaplus (非推奨)

脆弱性が放置されているらしい上に ZIP64 および UTF-8 対応が全然ダメなので、
昔お世話になったことには感謝しつつ消そう。

#### 7-zip

多分これが一番いい。
winget でインストール可能。

#### Python zip

Windows python がインストールされているなら (winget 可能)
実はこれで圧縮展開できる。ZIP64 対応。
WSL 内の python は VM 跨ぎのファイルシステムとなるため非推奨。

```bat
python -m zipfile --help
```

### 自動起動

#### Windows から WSL を呼ぶ

Windows から WSL 内のコマンド呼び出しは `wsl.exe` で簡単にできる。
カレントディレクトリも Windows/Linux のどちらも指定できる。

```bat
> wsl.exe --help
オプション:
   --cd <ディレクトリ>
       指定されたディレクトリを現在の作業ディレクトリとして設定します。
       ~ が使用されている場合、Linux ユーザーのホーム パスが使用されます。パスが
       / の文字で始まる場合、絶対 Linux パスとして解釈されます。
       それ以外の場合、値は絶対 Windows パスである必要があります。

   --distribution, -d <ディストリビューション>
       指定されたディストリビューションを実行します。

   --user, -u <ユーザー名>
       指定されたユーザーとして実行します。

> wsl.exe --cd ~ ls
```

#### タスクスケジューラ

Windows の cron みたいなもの。
多分これを使うのがいい。

#### WSL - cron

使えないことはないけど、WSL2 だと VM が起動している間でないと動かない。。

### サーバへの転送

圧縮ファイルの形になればもはやただの長いバイナリ列で、
ファイルシステムよりもネットワークの方が非常に遅いため、
WSL の rsync を使ってよさそう。

#### rsync

ssh 越しにも使える安心の同期ツール。

#### scp

ssh 越しに圧縮ファイルを1個転送するだけなら scp でよさそうな気もするが、
近年脆弱性が見つかっており、コード全体の設計が古めかしく根本解決が難しそうな雰囲気。
少々オーバースペックなケースであっても rsync 推奨の流れあり。
